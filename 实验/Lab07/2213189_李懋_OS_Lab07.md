# OS_Lab07

| **姓名** | **李懋**                       |
| -------- | ------------------------------ |
| **学号** | **2213189**                    |
| **邮箱** | **2213189@mail.nankai.edu.cn** |



[TOC]



## 1 实验题目

- 多线程拷贝目录及子目录



## 2 实验目的

1. 掌握多线程编程的基本概念和实现方法。
2. 理解多线程在文件拷贝中的应用，比较单进程、多进程和多线程在文件拷贝中的效率差异。
3. 学习使用POSIX线程库（pthread）进行多线程编程。
4. 掌握目录遍历和文件操作的基本方法。
5. 验证多线程拷贝目录的正确性，并比较不同方法的优缺点。



## 3 实验原理

### 1. 涉及的知识点

1. **多线程编程**：
   - 使用POSIX线程库（pthread）创建和管理线程。
   - 线程之间共享进程的资源，但需要通过互斥量（mutex）来保护共享资源，避免竞态条件。
2. **目录遍历**：
   - 使用`opendir()`、`readdir()`和`closedir()`函数遍历目录。
   - 通过`struct dirent`结构体获取目录项的信息，包括文件名和文件类型。
3. **文件拷贝**：
   - 使用`open()`、`read()`、`write()`和`close()`函数进行文件的读写操作。
   - 使用`mkdir()`函数创建目标目录。
4. **生产者-消费者模型**：
   - 一个线程负责遍历源目录并将文件路径放入待拷贝文件的数组中（生产者）。
   - 多个线程负责从数组中取出文件路径并进行拷贝（消费者）。
   - 使用互斥量保护共享的数组，确保线程安全。



### 2. 实现思路

程序的核心功能是多进程并行复制一个目录中的所有文件，使用共享内存实现任务队列，具体思路如下：

1. **任务队列实现**：
   - 使用共享内存保存一个循环队列，用于存储文件路径。
   - 父进程负责将要复制的文件路径加入队列。
   - 子进程负责从队列中取出路径并执行文件复制操作。
2. **多进程并行**：
   - 使用 `fork()` 创建多个子进程，提高文件复制的并行效率。
   - 每个子进程从共享队列中取文件路径并复制文件。
3. **目录遍历**：
   - 父进程递归遍历源目录，将所有文件路径加入共享任务队列。
   - 如果遇到子目录，递归处理以保证所有层级的文件都被加入队列。
4. **目录创建和文件复制**：
   - 子进程在复制文件前，确保目标目录结构存在。
   - 文件复制使用低级 I/O (`open/read/write`) 实现。
5. **进程同步**：
   - 父进程向队列中添加特殊标记（空路径字符串），通知子进程任务完成。
   - 父进程通过 `wait()` 等待所有子进程完成任务。
6. **资源管理**：
   - 使用 `mmap` 创建共享内存，程序结束时正确释放。
   - 避免文件描述符泄漏、内存泄漏等问题。





## 4 实验具体步骤

1. Install GCC（不再多赘述）
2. 目标文件夹linux最新内核包，重命名为linux-2
   ![image-20241214102637229](E:\TyporaPictures\image-20241214102637229.png)
3. 编写代码，实现思路如上实验原理，在最后给出实验源代码
4. 编译运行









## 5 实验总结

1. **多进程的优势**：
   - 多进程能够充分利用多核CPU的并行处理能力，尤其是在处理大量小文件时，多进程的效率较高。
   - 进程间通信的开销较大，但在处理大文件时，多进程的效率可能优于多线程。
2. **多进程的劣势**：
   - 进程间通信和同步的开销较大，尤其是在频繁的文件操作中，可能会影响整体性能。
   - 进程的管理和回收需要额外的代码实现，增加了程序的复杂性。
3. **与多线程的比较**：
   - 多线程在处理大量小文件时，由于线程间通信和同步的开销较小，效率可能优于多进程。
   - 多进程在处理大文件时，由于进程的独立性，可能会有更好的表现。

通过本次实验，掌握了多进程编程的基本方法，还深入理解了多进程与多线程在文件拷贝中的性能差异，为今后的并发编程打下了坚实的基础。